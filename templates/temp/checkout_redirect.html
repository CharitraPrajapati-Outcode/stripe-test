<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Checkout (Redirect)</title>
</head>
<body>
  <h1>Buy a Plan (simple redirect)</h1>

  <form id="checkout-form">
    <label>
      Price ID:
      <input id="price_id" name="price_id" placeholder="price_..." required />
    </label>
    <button type="submit">Checkout</button>
  </form>

  <script>
    // Helper to read CSRF cookie (Django default)
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]+)'));
      return match ? decodeURIComponent(match[2]) : null;
    }

    document.getElementById('checkout-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const priceId = document.getElementById('price_id').value.trim();
      if (!priceId) return alert('Enter price id');

      // If you use JWT, place it into the template context as `jwt_token`
      const jwt = '{{ jwt_token|default:"" }}'; // set by view if available

      const headers = {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      };
      if (jwt) headers['Authorization'] = 'Bearer ' + jwt;

      try {
        const res = await fetch('/api/subscriptions/checkout/', {
          method: 'POST',
          headers,
          body: JSON.stringify({ price_id: priceId }),
        });

        const data = await res.json();
        if (!res.ok) {
          alert(data.detail || 'Checkout API error');
          return;
        }

        // If backend returns `url`, do a direct browser navigation
        if (data.url) {
          window.location.href = data.url;
          return;
        }

        // Fallback: maybe backend returned sessionId/publishableKey
        alert('No `url` returned. Received: ' + JSON.stringify(data));
      } catch (err) {
        console.error(err);
        alert('Network error');
      }
    });
  </script>
</body>
</html>