{% extends "home.html" %}

{% block content %}
  {% csrf_token %}
  <div class="row justify-content-center">
    <div class="col-12 col-md-8">
      <div class="card">
        <div class="card-body">
          <style>
            /* Simplified, elegant subscription card */
            .sub-card { border:1px solid #eef2f5; border-radius:12px; padding:0.35rem; background:#fff; }
            .sub-card:hover { box-shadow: 0 6px 18px rgba(20,30,50,0.06); }
            .sub-icon { width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; background:#f8fbff; color:#2b6fbf; }
            .status-pill { font-size:.78rem; padding:.2rem .45rem; border-radius:999px; }
            .price-box { min-width:84px; text-align:right; }
            .muted-small { color:#6c757d; font-size:.92rem; }
            .accent-left { width:6px; border-radius:8px; margin-right:.65rem; background:#dfeffb }
            .sub-actions .btn { padding:.35rem .6rem; font-size:.82rem; }
          </style>
            <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2 class="card-title">Dashboard</h2>
              <p class="mb-1">Welcome, <strong>{{ user.username }}</strong>!
                {% for role in user_roles %}
                  <span class="badge bg-secondary ms-2 text-capitalize">{{ role }}</span>
                {% endfor %}
              </p>
              <p class="mb-0">Email: {{ user.email }}</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <button class="btn btn-sm btn-outline-info" id="refresh-btn" onclick="refreshSubscriptions()">ðŸ”„ Refresh</button>
              <a class="btn btn-sm btn-primary" href="{% url 'accounts:subscriptions' %}">View subscriptions</a>
              <a class="btn btn-sm btn-outline-info" href="{% url 'accounts:connect_info' %}">Connected account</a>
              <a class="btn btn-outline-secondary btn-sm" href="{% url 'accounts:logout' %}">Logout</a>
            </div>
          </div>

          <hr />
          <h5>Your Subscriptions</h5>
          <div class="mt-3">
            {% if active_subscriptions and active_subscriptions.exists %}
              <div class="row g-3 mt-2">
                {% for s in active_subscriptions %}
                  <div class="col-12">
                    <div class="sub-card d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center">
                        <div class="sub-icon me-3">ðŸ’ </div>
                        <div>
                          <div class="fw-semibold">{{ s.plan.name }}</div>
                          <div class="muted-small">
                            {% if s.cancel_at_period_end and s.current_period_end %}
                              Ending at <strong>{{ s.current_period_end|date:"M j, Y" }}</strong>
                            {% elif s.current_period_end %}
                              Next billing: <strong>{{ s.current_period_end|date:"M j, Y" }}</strong>
                            {% elif s.current_period_start %}
                              Started: <strong>{{ s.current_period_start|date:"M j, Y" }}</strong>
                            {% else %}
                              Status: <strong>{{ s.status|capfirst }}</strong>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      <div class="d-flex align-items-center">
                        <div class="price-box me-3 text-end">
                          <div class="text-muted small">Price</div>
                          <div class="fw-semibold">{{ s.plan.price|floatformat:2 }}</div>
                        </div>
                        <div class="sub-actions">
                          {% if s.cancel_at_period_end %}
                            <button class="btn btn-sm btn-outline-secondary me-1" disabled>Cancel at period end</button>
                          {% else %}
                            <form method="post" action="{% url 'accounts:cancel_subscription' s.stripe_subscription_id %}" class="d-inline me-1">
                              {% csrf_token %}
                              <input type="hidden" name="when" value="period_end">
                              <button type="submit" class="btn btn-sm btn-outline-secondary">Cancel at period end</button>
                            </form>
                          {% endif %}
                          <form method="post" action="{% url 'accounts:cancel_subscription' s.stripe_subscription_id %}" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="when" value="now">
                            <button type="submit" class="btn btn-sm btn-danger">Cancel now</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="mt-3">You have no active subscriptions.</div>
            {% endif %}
          </div>
  
          {% if plans %}
            <hr />
            <h6>Available Plans from "{{ stripe_account_name|default:'Stripe' }}"</h6>
            <div class="row">
                {% for plan in plans %}
                <div class="col-12 col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                      <h6 class="card-title">{{ plan.product_name|default:plan.id }}</h6>
                      <p class="card-text mb-2"><strong>{{ plan.amount }}</strong> {{ plan.currency }} {% if plan.interval %}/ {{ plan.interval }}{% endif %}</p>
                            <div class="mt-auto">
                              {% if subscribed_price_ids and plan.id in subscribed_price_ids %}
                                <button class="btn btn-sm btn-secondary" disabled>Subscribed</button>
                              {% else %}
                                <a class="btn btn-sm btn-primary" href="{% url 'accounts:subscribe' plan.id %}">Subscribe</a>
                              {% endif %}
                            </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            {% if stripe_error %}
              <div class="alert alert-warning mt-3">Unable to load plans: {{ stripe_error }}</div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    function refreshSubscriptions() {
      const btn = document.getElementById('refresh-btn');
      btn.disabled = true;
      btn.textContent = 'â³ Refreshing...';

      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
      console.log('CSRF Token:', csrfToken);
      console.log('Fetching from:', '{% url "accounts:api_refresh_subscriptions" %}');

      fetch('{% url "accounts:api_refresh_subscriptions" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        }
      })
      .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          alert(`âœ“ ${data.message}`);
          location.reload();
        } else {
          alert(`âš  ${data.message}\n\n${data.errors.join('\n')}`);
          btn.disabled = false;
          btn.textContent = 'ðŸ”„ Refresh';
        }
      })
      .catch(error => {
        console.error('Fetch error:', error);
        alert(`âœ— Error: ${error.message}`);
        btn.disabled = false;
        btn.textContent = 'ðŸ”„ Refresh';
      });
    }
  </script>
  {% include 'includes/subscriptions_sse.html' %}
{% endblock %}

