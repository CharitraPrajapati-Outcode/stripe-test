{% extends "home.html" %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-12 col-md-8">
      <div class="card">
        <div class="card-body">
          <style>
            /* Simplified, elegant subscription card */
            .sub-card { border:1px solid #eef2f5; border-radius:12px; padding:0.35rem; background:#fff; }
            .sub-card:hover { box-shadow: 0 6px 18px rgba(20,30,50,0.06); }
            .sub-icon { width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; background:#f8fbff; color:#2b6fbf; }
            .status-pill { font-size:.78rem; padding:.2rem .45rem; border-radius:999px; }
            .price-box { min-width:84px; text-align:right; }
            .muted-small { color:#6c757d; font-size:.92rem; }
            .accent-left { width:6px; border-radius:8px; margin-right:.65rem; background:#dfeffb }
            .sub-actions .btn { padding:.35rem .6rem; font-size:.82rem; }
          </style>
            <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2 class="card-title">Dashboard</h2>
              <p class="mb-1">Welcome, <strong>{{ user.username }}</strong>!</p>
              <p class="mb-0">Email: {{ user.email }}</p>
            </div>
            <div class="d-flex gap-2">
              <a class="btn btn-sm btn-primary" href="{% url 'accounts:subscriptions' %}">View subscriptions</a>
              <a class="btn btn-outline-secondary btn-sm" href="{% url 'accounts:logout' %}">Logout</a>
            </div>
          </div>

          <hr />
          <h5>Your Subscriptions</h5>
          <div class="mt-3">
            {% if active_subscriptions and active_subscriptions.exists %}
              <div class="row g-3 mt-2">
                {% for s in active_subscriptions %}
                  <div class="col-12">
                    <div class="sub-card d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center">
                        <div class="sub-icon me-3">ðŸ’ </div>
                        <div>
                          <div class="fw-semibold">{{ s.plan.name }}</div>
                          <div class="muted-small">
                            {% if s.cancel_at_period_end and s.current_period_end %}
                              Ending at <strong>{{ s.current_period_end|date:"M j, Y" }}</strong>
                            {% elif s.current_period_end %}
                              Next billing: <strong>{{ s.current_period_end|date:"M j, Y" }}</strong>
                            {% elif s.current_period_start %}
                              Started: <strong>{{ s.current_period_start|date:"M j, Y" }}</strong>
                            {% else %}
                              Status: <strong>{{ s.status|capfirst }}</strong>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      <div class="d-flex align-items-center">
                        <div class="price-box me-3 text-end">
                          <div class="text-muted small">Price</div>
                          <div class="fw-semibold">{{ s.plan.price|floatformat:2 }}</div>
                        </div>
                        <div class="sub-actions">
                          {% if s.cancel_at_period_end %}
                            <button class="btn btn-sm btn-outline-secondary me-1" disabled>Cancel at period end</button>
                          {% else %}
                            <form method="post" action="{% url 'accounts:cancel_subscription' s.stripe_subscription_id %}" class="d-inline me-1">
                              {% csrf_token %}
                              <input type="hidden" name="when" value="period_end">
                              <button type="submit" class="btn btn-sm btn-outline-secondary">Cancel at period end</button>
                            </form>
                          {% endif %}
                          <form method="post" action="{% url 'accounts:cancel_subscription' s.stripe_subscription_id %}" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="when" value="now">
                            <button type="submit" class="btn btn-sm btn-danger">Cancel now</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="mt-3">You have no active subscriptions.</div>
            {% endif %}
          </div>
  
          {% if plans %}
            <hr />
            <h6>Available Plans from "{{ stripe_account_name|default:'Stripe' }}"</h6>
            <div class="row">
              {% for plan in plans %}
                <div class="col-12 col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                      <h6 class="card-title">{{ plan.product_name|default:plan.id }}</h6>
                      <p class="card-text mb-2"><strong>{{ plan.amount }}</strong> {{ plan.currency }} {% if plan.interval %}/ {{ plan.interval }}{% endif %}</p>
                            <div class="mt-auto">
                              <a class="btn btn-sm btn-primary" href="{% url 'accounts:subscribe' plan.id %}">Subscribe</a>
                            </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            {% if stripe_error %}
              <div class="alert alert-warning mt-3">Unable to load plans: {{ stripe_error }}</div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
